# Cosmic P2P
`Cosmic.P2P` is a grid network solution as a subsystem of Bryllite.NET that enables real-time inter-node consensus in a blockchain network

## What is Bryllite.NET
Bryllite.NET is a consortium blockchain platform service developed with the goal of sharing payment and economic systems with each other by connecting the payment and economic systems of independent game services into one ecosystem

The video below makes it easy to understand the Bryllite.NET platform

[![Bryllite Official YouTube](https://img.youtube.com/vi/G-UW7Zk2DyA/maxresdefault.jpg)](https://www.youtube.com/watch?v=G-UW7Zk2DyA)

The Bryllite.NET project can be found [here](https://github.com/trieton-works/bryllite.net)

## Why We need Cosmic.P2P

### Double-Spending Issue
Most blockchain platforms, including Bitcoin and Ethereum, create Blocks through hash competition and consensus among nodes. Aside from the controversy over the excessive energy consumed in this process, Block generation consensus through hash competition can cause double-spending issue.  
  
Even if a node creates the n'th Block and processes the transaction for that Block, if another node creates the n', n'+1 Block first, As block n is replaced with block n', transactions that have already been processed may be invalidated. This is like purchasing coffee through cryptocurrency payment at Starbucks, and after a certain period of time, the payment becomes invalid and the cryptocurrency balance becomes available again. This problem is called the double-spending issue, and each blockchain platform avoids the double-spending issue by waiting for the creation of N Blocks.  

### Cannot be used as money in real world
Waiting for the creation of N Blocks means that the time consumed for payment increases dramatically. In the case of Bitcoin, which is known to have an average Block generation time of about 10 minutes, generally wait for 6 Blocks to be created before confirming the transaction, In the case of Ethereum, where the average Block creation time is about 15 seconds, the transaction is confirmed after waiting for the creation of 12 - 48 Blocks.

That is, even if my transaction is included in the Block and the transaction is approved, the transaction is confirmed after waiting at least a few minutes to an hour. This makes it almost impossible for us to buy coffee with cryptocurrency payments at Starbucks and the like.

### Real-Time Inter-Node Consensus
The long waiting time for transaction confirmation is caused by the double-spending issue and the waiting time to generate N Blocks to avoid it. The double-spending problem occurs because each node participating in the network competes by generating Blocks independently, and as a result of the competition, blocks generated by a node may be overwritten by Blocks generated by other nodes.

If all nodes participating in the network can cooperatively agree on Block generation at the same time and the Block created cannot be overwritten, the waiting time for transaction confirmation will be dramatically reduced.

### The Need of Cosmic.P2P
`Cosmic.P2P` is a grid networking solution designed to allow all nodes participating in the network to agree in real time. We can agree to Block creation through Cosmic.P2P, or agree to confirm the transaction for pending transactions.

## HOW IT WORKS

### Basic Principle of Cosmic.P2P Operation
Mining nodes participating in the network know the addresses of all mining nodes participating in the network through the `Node Discovery Service`

If one node(sender) wants to send a message to the entire network,

* The sender determines the layout of the grid based on the size of the mining node participating in the network. The layout expressed in a 3D-Coordinates system of [x, y, z]. (E.g. layout = [3, 3, 3])
  Reference: Layout Decision based on nPeers

* The coordinates of each node are deterministic by the layout.
  Reference: Computing the Coordinates of a node

* The sender randomly selects one of the nodes belonging to the grid and transmits a message to the node, The recipient receiving this message relays the message to all nodes in the grid. If the sender is included in the grid while selecting one of the nodes belonging to the grid, always select the sender. If the message transfer to the selected node fails, select the next node and send it again.

* Depending on the layout, the relay is done in the order of z-axis, y-axis, x-axis.
  Reference: How message broadcasting works

### Layout Decision based on nPeers
  The layout is determined by the sender when sending message, and is determined by the number(`nPeers`) of nodes participating in the entire network and the number(`N`) of nodes to be included in a grid.

> N: Number of nodes to include in one grid  
> nPeers: The total number of nodes participating in the network

The figure below shows how to determine the layout according to the number of total nodes participating in the network(`nPeers`) and the number of nodes to be included in a grid(`N`)

![layout decision 1](https://flexgrid.bryllite.net/static/media/layout-decision1.5ffbb0ba.jpg)
![layout decision 2](https://flexgrid.bryllite.net/static/media/layout-decision2.c199f25b.jpg)

Each box in the above figure has about `N` nodes

### Computing the Coordinates of a node
The Coordinates of the node are determined by extracting the `hx`, `hy`, and `hz` values from the hash value of the node address, and performing the remaining operations on each coordinate axis size of the layout
![computing coordinate](https://flexgrid.bryllite.net/static/media/coordinates.96fd7805.jpg)

> CoordinatesOf(Node).X = 1 + ( hx mod layout.X )  
> CoordinatesOf(Node).Y = 1 + ( hy mod layout.Y )  
> CoordinatesOf(Node).Z = 1 + ( hz mod layout.Z )  

These coordinates are deterministic according to the address of the nodes and layout, and they are uniformly distributed in each grid

### How message broadcasting works

For example, if you have `81` participating nodes and the layout is `[3, 3, 3]`, you can describe message broadcasting as follows: One box in the figure below contains about `3` nodes.

#### Z-Axis message transmission

If the size of the layout's z-axis is greater than 1, the entire node is divided by the z coordinates as shown below, and the message is relayed to each coordinate.

![z-axis message transmission](https://flexgrid.bryllite.net/static/media/z-axis-transmission.9223275f.jpg)
* Sends a message to one randomly selected node among all nodes with a z-axis coordinate of 1 ( In this case, since the sender is included, select the sender )
* Sends a message to one randomly selected node among all nodes with a z-axis coordiate of 2
* Sends a message to one randomly selected node among all nodes with a z-axis coordiate of 3
* The node received this message relays the message on the Y axis in the same ways as the Y Axis message transmission below

#### Y-Axis message transmission
If the size of the layout's y-axis is greater than 1, the entire node is divided by the y coordinates as show below, and the message is relayed to each coordinate. When relaying messages received via Z-Axis message transmission to the Y-Axis, the range of the entire node is limited to the corresponding z-axis coordinates

![y-axis message transmission](https://flexgrid.bryllite.net/static/media/y-axis-transmission.3305cedd.jpg)
* Sends a message to one randomly selected node among all nodes with a y-axis coordinates of 1
* Sends a message to one randomly selected node among all nodes with a y-axis coordinates of 2 ( In this case, since the sender is included, select the sender )
* Sends a message to one randomly selected node among all nodes with a y-axis coordinates of 3
* The node received this message relays the message on the X axis in the same ways as the X Axis message transmission below

#### X-Axis message transmission
If the size of the layout's x-axis is greater than 1, the entire node is divided by the x coordinates shown below, and the message is relayed to each coordinate. When relaying message received via Y-Axis message transmission to the X-Axis, the range of the entire node is limited to the corresponding z-axis coordinates and y-axis coordinates
![x-axis message transmission](https://flexgrid.bryllite.net/static/media/x-axis-transmission.1249822a.jpg)

* Sends a message to one randomly selected node among all nodes with a x-axis coordinates of 1
* Sends a message to one randonly selected node among all nodes with a x-axis coordinates of 2 ( In this case, since the sender in included, select the sender )
* Sends a message to one randonly selected node among all nodes with a x-axis coordinates of 3
* The node that receives this message sends a message to all nodes that belong to that coordinate. This process completes the message broadcasting to the entire network

## Coverage
* A node can broadcast to N ^ 4 nodes with N * 4 send call.
* A node can broadcast to 4,096 nodes with 32 send call ( if N = 8 )
* A node can broadcast to 65,536 nodes with 64 send call ( if N = 16 )
* A node can broadcast to 1,048,576 nodes with 128 send call ( if N = 32 )
* And also can be extended to 4D-Coordiantes system( x, y, z, w ) 
A node can broadcast to N ^ 5 nodes with N * 5 send call on 4D-Coordinates system.